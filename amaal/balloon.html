#include <SPI.h>
#include <MFRC522.h>
#include <Keyboard.h> 

#define SS_PIN 10
#define RST_PIN 9

MFRC522 mfrc522(SS_PIN, RST_PIN);

// --- CONFIGURATIE ---
String masterCard = "29 A2 15 B9"; // Jouw kaart ID
String email = "admin123@gmail.com";
String wachtwoord = "Admin123";

void setup() {
  Serial.begin(9600);
  while (!Serial); // Wacht op Serial Monitor (belangrijk voor Leonardo!)
  
  Serial.println("=== RFID Login Systeem ===");
  Serial.println("Initializing SPI...");
  
  SPI.begin();
  
  Serial.println("Initializing MFRC522...");
  mfrc522.PCD_Init();
  delay(100); // Geef RC522 tijd om op te starten
  
  // Test of RC522 communiceert
  byte version = mfrc522.PCD_ReadRegister(mfrc522.VersionReg);
  Serial.print("MFRC522 Firmware versie: 0x");
  Serial.println(version, HEX);
  
  if (version == 0x00 || version == 0xFF) {
    Serial.println("⚠️ FOUT: RC522 niet gevonden!");
    Serial.println("Check je bedrading:");
    Serial.println("  - SDA -> Pin 10");
    Serial.println("  - SCK -> ICSP-3");
    Serial.println("  - MOSI -> ICSP-4");
    Serial.println("  - MISO -> ICSP-1");
    Serial.println("  - RST -> Pin 9");
    Serial.println("  - 3.3V -> 3.3V (NIET 5V!)");
    Serial.println("  - GND -> GND");
    while(1); // Stop hier
  } else {
    Serial.println("✓ RC522 communicatie OK!");
  }
  
  // Extra diagnose info
  mfrc522.PCD_DumpVersionToSerial();
  
  Keyboard.begin();
  
  Serial.println("\n✓ Systeem gereed!");
  Serial.print("Master kaart UID: ");
  Serial.println(masterCard);
  Serial.println("\n>>> Houd je kaart/tag DICHT bij de reader <<<");
  Serial.println(">>> (binnen 3-5 cm) <<<\n");
}

void loop() {
  // Check of er een kaart in de buurt is
  if (!mfrc522.PICC_IsNewCardPresent()) {
    return; // Geen kaart, probeer opnieuw
  }

  // Probeer de kaart te lezen
  if (!mfrc522.PICC_ReadCardSerial()) {
    Serial.println("⚠️ Kaart detectie gefaald - probeer opnieuw");
    return;
  }

  Serial.println("\n━━━━━━━━━━━━━━━━━━━━━━");
  Serial.println("✓ Kaart gedetecteerd!");
  Serial.println("━━━━━━━━━━━━━━━━━━━━━━");

  // Bouw UID string op
  String uidStr = "";
  for (byte i = 0; i < mfrc522.uid.size; i++) {
    if (mfrc522.uid.uidByte[i] < 0x10) {
      uidStr += "0";
    }
    uidStr += String(mfrc522.uid.uidByte[i], HEX);
    if (i < mfrc522.uid.size - 1) {
      uidStr += " ";
    }
  }
  uidStr.toUpperCase();

  Serial.print("Gescande UID:  ");
  Serial.println(uidStr);
  Serial.print("Master kaart:  ");
  Serial.println(masterCard);

  // Vergelijk met master kaart
  if (uidStr == masterCard) {
    Serial.println("\n✓✓✓ CORRECT! Inloggen... ✓✓✓\n");
    
    // Type email
    Keyboard.print(email);
    delay(50);
    
    // Druk TAB
    Keyboard.press(KEY_TAB); 
    Keyboard.releaseAll();
    delay(100);

    // Type wachtwoord
    Keyboard.print(wachtwoord); 
    delay(100);

    // Druk ENTER
    Keyboard.press(KEY_RETURN);
    Keyboard.releaseAll();
    
    Serial.println("Login credentials verstuurd!");
  } else {
    Serial.println("\n✗✗✗ FOUT! Onbekende kaart ✗✗✗");
    Serial.println("Deze kaart is niet geregistreerd.\n");
  }

  // Stop communicatie met huidige kaart
  mfrc522.PICC_HaltA();
  
  Serial.println("━━━━━━━━━━━━━━━━━━━━━━");
  Serial.println("Wacht 2 seconden...");
  Serial.println("Scan opnieuw mogelijk\n");
  
  delay(2000); 
}
