<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Perfume Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBv4nvU1jBORACQkMZhGnhcXzlMXfFQ-I4",
      authDomain: "parfum-9f3dd.firebaseapp.com",
      projectId: "parfum-9f3dd",
      storageBucket: "parfum-9f3dd.appspot.com",
      messagingSenderId: "327611693398",
      appId: "1:327611693398:web:0838f0e60115808744fef7",
      measurementId: "G-KG9V99E8WE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginSection = document.getElementById("login-section");
    const adminSection = document.getElementById("admin-section");
    const logoutBtn = document.getElementById("logout-btn");
    const perfumeForm = document.getElementById("perfume-form");
    const perfumeList = document.getElementById("perfume-list");
    const orderList = document.getElementById("order-list");
    const statusBox = document.getElementById("status");

    let editId = null;

    // RFID buffer systeem - vangt alle input op
    let rfidBuffer = "";
    let rfidTimeout = null;

    // Luister naar ALLE toetsaanslagen op de pagina
    document.addEventListener("keypress", (e) => {
      // Voorkom dat dit interfereert met admin formulieren
      if (adminSection.style.display === "block") return;
      
      // Voeg karakter toe aan buffer
      if (e.key === "Enter") {
        // RFID scanner stuurt Enter aan het einde
        processRFIDScan(rfidBuffer.trim());
        rfidBuffer = "";
        clearTimeout(rfidTimeout);
      } else {
        rfidBuffer += e.key;
        
        // Reset buffer na 500ms inactiviteit
        clearTimeout(rfidTimeout);
        rfidTimeout = setTimeout(() => {
          rfidBuffer = "";
        }, 500);
      }
    });

    async function processRFIDScan(scannedData) {
      // Hier kun je de gescande data verwerken
      // Bijvoorbeeld: als de scan een specifiek formaat heeft
      // Voor nu: automatisch inloggen met de credentials
      try {
        await signInWithEmailAndPassword(auth, "admin123@gmail.com", scannedData);
      } catch (err) { 
        console.log("RFID scan mislukt");
        // Toon visuele feedback
        const instruction = document.querySelector(".rfid-instruction");
        if (instruction) {
          instruction.style.borderColor = "var(--danger)";
          setTimeout(() => {
            instruction.style.borderColor = "var(--accent)";
          }, 1000);
        }
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const adminEmail = "admin123@gmail.com";
        if (user.email !== adminEmail) {
          await signOut(auth);
          return;
        }
        statusBox.innerHTML = `Ingelogd als: <strong>${user.email}</strong>`;
        loginSection.style.display = "none";
        adminSection.style.display = "block";
        loadPerfumes();
        loadOrders();
      } else {
        statusBox.innerHTML = "";
        loginSection.style.display = "block";
        adminSection.style.display = "none";
      }
    });

    logoutBtn.addEventListener("click", () => signOut(auth));

    async function loadPerfumes() {
      perfumeList.innerHTML = "<p>Laden...</p>";
      const querySnapshot = await getDocs(collection(db, "perfumes"));
      perfumeList.innerHTML = "";
      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "perfume-card";
        div.innerHTML = `
          <img src="${data.image || 'https://via.placeholder.com/150'}" alt="${data.name}">
          <div class="perfume-info">
            <strong>${data.brand} - ${data.name}</strong>
            <small>${data.gender} | ${data.type}</small>
            <p style="font-size: 0.8rem; margin: 5px 0;">${data.scent}</p>
            <span class="price-tag">‚Ç¨${data.price}</span>
          </div>
          <div class="card-actions">
            <button onclick="window.startEdit('${docSnap.id}')" class="btn-edit">Bewerk</button>
            <button onclick="window.deletePerfume('${docSnap.id}')" class="btn-danger-sm">Verwijder</button>
          </div>
        `;
        perfumeList.appendChild(div);
      });
    }

    async function loadOrders() {
      orderList.innerHTML = "<p>Laden...</p>";
      const querySnapshot = await getDocs(collection(db, "orders"));
      orderList.innerHTML = "";
      const orders = [];
      querySnapshot.forEach(d => orders.push({id: d.id, ...d.data()}));
      orders.sort((a,b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

      orders.forEach(order => {
        const div = document.createElement("div");
        div.className = `order-card ${order.prepared ? 'is-prepared' : ''}`;
        div.innerHTML = `
          <div class="order-header">
            <strong>Bestelling #${order.id.slice(0,6)}</strong>
            <span>${order.timestamp?.toDate().toLocaleDateString('nl-NL') || ''}</span>
          </div>
          <div class="order-body">
            <p><strong>Klant:</strong> ${order.name}</p>
            <p><strong>Items:</strong><br> ${order.items?.map(i => `‚Ä¢ ${i.quantity}x ${i.name}`).join('<br>') || 'Geen items'}</p>
          </div>
          <div class="order-footer">
             <label class="checkbox-label">
                <input type="checkbox" ${order.prepared ? 'checked' : ''} onchange="window.togglePrepared('${order.id}', this.checked)">
                <span>Voorbereid</span>
             </label>
             <button onclick="window.deleteOrder('${order.id}')" class="btn-danger-sm">Wis</button>
          </div>
        `;
        orderList.appendChild(div);
      });
    }

    perfumeForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const perfumeData = {
        name: perfumeForm["name"].value,
        brand: perfumeForm["brand"].value,
        price: parseFloat(perfumeForm["price"].value),
        type: perfumeForm["type"].value,
        scent: perfumeForm["scent"].value,
        gender: perfumeForm["gender"].value,
        image: perfumeForm["image"].value
      };

      try {
        if (editId) {
          await updateDoc(doc(db, "perfumes", editId), perfumeData);
          editId = null;
          perfumeForm.querySelector("button").textContent = "Toevoegen";
        } else {
          await addDoc(collection(db, "perfumes"), perfumeData);
        }
        perfumeForm.reset();
        loadPerfumes();
      } catch (err) { alert(err.message); }
    });

    window.togglePrepared = async (id, status) => {
      await updateDoc(doc(db, "orders", id), { prepared: status });
      loadOrders();
    };

    window.deletePerfume = async (id) => {
      if(confirm("Verwijderen?")) { await deleteDoc(doc(db, "perfumes", id)); loadPerfumes(); }
    };

    window.deleteOrder = async (id) => {
        if(confirm("Order verwijderen?")) { await deleteDoc(doc(db, "orders", id)); loadOrders(); }
    }

    window.startEdit = async (id) => {
      const querySnapshot = await getDocs(collection(db, "perfumes"));
      querySnapshot.forEach(docSnap => {
        if(docSnap.id === id) {
          const d = docSnap.data();
          editId = id;
          perfumeForm["name"].value = d.name;
          perfumeForm["brand"].value = d.brand;
          perfumeForm["price"].value = d.price;
          perfumeForm["type"].value = d.type;
          perfumeForm["scent"].value = d.scent;
          perfumeForm["gender"].value = d.gender || "";
          perfumeForm["image"].value = d.image || "";
          perfumeForm.querySelector("button").textContent = "Bijwerken";
          window.scrollTo(0,0);
        }
      });
    };
  </script>

  <style>
    :root {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --accent: #38bdf8;
      --text: #f1f5f9;
      --danger: #ef4444;
      --success: #22c55e;
      --border: #334155;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      margin: 0;
      padding: 20px;
    }

    .container { max-width: 1100px; margin: auto; }
    
    header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 30px; 
      border-bottom: 1px solid var(--border);
      padding-bottom: 15px;
    }

    .card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      border: 1px solid var(--border);
    }

    h2 { margin-top: 0; font-size: 1.1rem; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }

    input, select {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: white;
      border-radius: 8px;
      box-sizing: border-box;
    }

    button { cursor: pointer; border: none; border-radius: 8px; font-weight: 600; transition: 0.2s; }

    .btn-primary { background: var(--accent); color: #000; width: 100%; padding: 12px; }
    .btn-danger-sm { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 5px 12px; font-size: 0.8rem; }
    .btn-danger-sm:hover { background: var(--danger); color: white; }
    .btn-edit { background: var(--accent); color: #000; padding: 5px 12px; font-size: 0.8rem; }

    /* RFID instructie styling */
    .rfid-instruction {
      text-align: center;
      margin: 40px 0;
      padding: 60px 30px;
      background: rgba(56, 189, 248, 0.1);
      border: 3px dashed var(--accent);
      border-radius: 16px;
      transition: border-color 0.3s;
    }

    .rfid-instruction svg {
      width: 120px;
      height: 120px;
      margin-bottom: 25px;
      fill: var(--accent);
      animation: pulse 2s infinite;
      filter: drop-shadow(0 0 20px rgba(56, 189, 248, 0.5));
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.05); }
    }

    .rfid-instruction h3 {
      margin: 0 0 15px 0;
      color: var(--accent);
      font-size: 1.8rem;
      font-weight: 700;
    }

    .rfid-instruction p {
      margin: 8px 0;
      color: var(--text);
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .rfid-instruction .subtitle {
      font-size: 0.95rem;
      opacity: 0.6;
      margin-top: 20px;
    }

    /* Orders styling */
    #order-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }

    .order-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      transition: 0.3s;
    }

    .order-card.is-prepared {
      border-color: var(--success);
      opacity: 0.7;
    }

    .order-header {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      background: rgba(56, 189, 248, 0.05);
    }

    .order-body { padding: 12px; flex-grow: 1; font-size: 0.9rem; }
    .order-body p { margin: 5px 0; }

    .order-footer {
      padding: 10px 12px;
      background: rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 0 0 10px 10px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      color: var(--accent);
    }

    .checkbox-label input { width: 18px; height: 18px; margin: 0; accent-color: var(--accent); }

    /* Perfume Grid */
    #perfume-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
    }

    .perfume-card {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .perfume-card img {
      width: 100%;
      height: 160px;
      object-fit: contain;
      background: #fff;
      padding: 10px;
    }

    .perfume-info { padding: 15px; }
    .perfume-info strong { display: block; font-size: 1rem; }
    .perfume-info small { color: var(--accent); }
    .price-tag { display: block; font-weight: bold; font-size: 1.1rem; margin-top: 10px; color: var(--success); }

    .card-actions { padding: 10px 15px; background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Perfume Admin</h1>
      <div id="status"></div>
      <button id="logout-btn" class="btn-danger-sm">Uitloggen</button>
    </header>

    <section id="login-section">
      <div class="card" style="max-width: 500px; margin: 80px auto;">
        <h2 style="text-align: center;">üîê BEVEILIGDE TOEGANG</h2>
        
        <div class="rfid-instruction">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 8H4V6h16m0 12H4v-6h16m0-8H4c-1.11 0-2 .89-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2z"/>
          </svg>
          <h3>Scan je RFID Kaart</h3>
          <p>Houd de kaart dicht bij de reader</p>
          <p class="subtitle">Alleen geautoriseerde kaarten hebben toegang</p>
        </div>
      </div>
    </section>

    <section id="admin-section" style="display:none;">
      <div class="card">
        <h2>üì¶ Bestellingen</h2>
        <div id="order-list"></div>
      </div>

      <div class="card">
        <h2>‚ú® Product Beheer</h2>
        <form id="perfume-form">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="text" id="brand" name="brand" placeholder="Merk (bijv. Montblanc)" required />
            <input type="text" id="name" name="name" placeholder="Naam (bijv. Explorer)" required />
            <input type="text" id="gender" name="gender" placeholder="Geslacht (Men/Women/Unisex)" required />
            <input type="text" id="type" name="type" placeholder="Type (bijv. Eau de Parfum)" required />
            <input type="number" step="0.01" id="price" name="price" placeholder="Prijs (‚Ç¨)" required />
            <input type="text" id="image" name="image" placeholder="Afbeelding URL" required />
          </div>
          <input type="text" id="scent" name="scent" placeholder="Geurnoten (bergamot, lavendel, etc.)" required />
          <button type="submit" class="btn-primary">Opslaan in Systeem</button>
        </form>
      </div>

      <h2>üß™ Voorraad</h2>
      <div id="perfume-list"></div>
    </section>
  </div>
</body>
</html>
